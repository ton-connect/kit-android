name: Publish to Maven Central

on:
  # Trigger on push to release branches
  push:
    branches:
      - 'release/**'
  
  # Trigger on GitHub releases
  release:
    types: [released, prereleased]
  
  # Allow manual workflow dispatch
  workflow_dispatch:
    inputs:
      publish_type:
        description: 'Publish type (staging or release)'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - release

jobs:
  validate:
    name: Validate Publishing Setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        working-directory: TONWalletKit-Android
        run: chmod +x gradlew

      - name: Validate publishing configuration
        working-directory: TONWalletKit-Android
        run: ./gradlew checkPomFileForMavenPublication
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}

  build:
    name: Build & Test SDK
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        working-directory: TONWalletKit-Android
        run: chmod +x gradlew

      - name: Run unit tests
        working-directory: TONWalletKit-Android
        run: ./gradlew :impl:testWebviewReleaseUnitTest

      - name: Build WebView Release variant
        working-directory: TONWalletKit-Android
        run: ./gradlew :impl:assembleWebviewRelease

      - name: Upload WebView AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: tonwalletkit-webview-release
          path: TONWalletKit-Android/impl/build/outputs/aar/impl-webview-release.aar
          retention-days: 30

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-publish
          path: TONWalletKit-Android/impl/build/test-results/
          retention-days: 7

  publish-staging:
    name: Publish to Maven Central (Staging)
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.publish_type == 'staging')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        working-directory: TONWalletKit-Android
        run: chmod +x gradlew

      - name: Publish to Maven Central (manual release required)
        working-directory: TONWalletKit-Android
        run: ./gradlew publishToMavenCentral --no-configuration-cache
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.SIGNING_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_KEY_CONTENTS }}

      - name: Publishing summary
        run: |
          echo "‚úÖ Published to Maven Central staging repository"
          echo ""
          echo "üì¶ Artifact: io.github.ton-connect:tonwalletkit-android"
          echo ""
          echo "üì¶ Next steps:"
          echo "1. Go to https://central.sonatype.com/publishing/deployments"
          echo "2. Review the staged artifacts"
          echo "3. Click 'Publish' to release to Maven Central"
          echo ""
          echo "‚ÑπÔ∏è  It takes 15-30 minutes for artifacts to appear after publishing"

  publish-release:
    name: Publish to Maven Central (Auto-Release)
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.publish_type == 'release')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        working-directory: TONWalletKit-Android
        run: chmod +x gradlew

      - name: Publish and Release to Maven Central (automatic)
        working-directory: TONWalletKit-Android
        run: ./gradlew publishAndReleaseToMavenCentral --no-configuration-cache
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.SIGNING_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_KEY_CONTENTS }}

      - name: Publishing summary
        run: |
          echo "‚úÖ Published and released to Maven Central automatically"
          echo ""
          echo "üì¶ Artifact will be available at:"
          echo "   https://central.sonatype.com/artifact/io.github.ton-connect/tonwalletkit-android"
          echo ""
          echo "‚ÑπÔ∏è  It takes 15-30 minutes for artifacts to appear in Maven Central"
          echo "‚ÑπÔ∏è  It may take several hours for them to be indexed and searchable"
