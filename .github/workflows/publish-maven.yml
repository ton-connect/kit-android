name: Publish to Maven Central

on:
  push:
    branches:
      - release
      - fix/publish-ci  # TODO: Remove after testing

jobs:
  # Build SDK and Publish to Maven Central
  build-and-publish:
    name: Build & Publish SDK
    runs-on: ubuntu-latest
    # TODO: Uncomment after testing
    # environment: release
    steps:
      - name: Checkout kit-android code
        uses: actions/checkout@v4

      - name: Get latest kit release info
        id: kit-release
        run: |
          RELEASE_INFO=$(curl -s https://api.github.com/repos/ton-connect/kit/releases/latest)
          TAG=$(echo "$RELEASE_INFO" | jq -r '.tag_name')
          ANDROID_BRIDGE_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | contains("walletkit-android-bridge")) | select(.name | endswith(".tgz")) | .browser_download_url')
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "android_bridge_url=$ANDROID_BRIDGE_URL" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Using kit release: $TAG"
          echo "ðŸ“¦ Android bridge URL: $ANDROID_BRIDGE_URL"

      - name: Download and extract Android bridge bundle
        run: |
          mkdir -p dist-android
          curl -sL "${{ steps.kit-release.outputs.android_bridge_url }}" -o android-bridge.tgz
          tar -xzf android-bridge.tgz
          cp package/dist/* dist-android/
          rm -rf package android-bridge.tgz
          echo "ðŸ“¦ Extracted Android bridge bundle:"
          ls -la dist-android/

      - name: Checkout kit repository for OpenAPI spec
        uses: actions/checkout@v4
        with:
          repository: ton-connect/kit
          ref: ${{ steps.kit-release.outputs.tag }}
          path: ton-repo
          sparse-checkout: |
            packages/walletkit-android-bridge

      - name: Determine version
        id: version
        run: |
          VERSION=$(grep "VERSION_NAME=" TONWalletKit-Android/gradle.properties | cut -d'=' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ SDK Version: $VERSION"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Grant execute permission for gradlew
        working-directory: TONWalletKit-Android
        run: chmod +x gradlew

      - name: Sync WebView Assets
        working-directory: TONWalletKit-Android
        run: ./gradlew syncWalletKitWebViewAssets

      # COMMENTED OUT: Skipping unit tests for faster publishing
      # - name: Run unit tests
      #   working-directory: TONWalletKit-Android
      #   run: ./gradlew :impl:testWebviewDebugUnitTest

      - name: Build WebView variant (Release)
        working-directory: TONWalletKit-Android
        run: ./gradlew buildWebviewRelease

      - name: Upload WebView AAR
        uses: actions/upload-artifact@v4
        with:
          name: sdk-webview-aar
          path: TONWalletKit-Android/impl/build/outputs/aar/impl-webview-release.aar
          retention-days: 7

      # TODO: Uncomment after testing
      # - name: Publish and Release to Maven Central
      #   working-directory: TONWalletKit-Android
      #   run: ./gradlew publishAndReleaseToMavenCentral --no-configuration-cache -PVERSION_NAME=${{ steps.version.outputs.version }}
      #   env:
      #     ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_USERNAME }}
      #     ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_PASSWORD }}
      #     ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.SIGNING_KEY_ID }}
      #     ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
      #     ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_KEY_CONTENTS }}

      - name: Publishing summary
        run: |
          echo "ðŸš€ Published to Maven Central"
          echo ""
          echo "ðŸ“¦ Artifact: org.ton:walletkit:${{ steps.version.outputs.version }}"
          echo "ðŸ“¦ Using kit release: ${{ steps.kit-release.outputs.tag }}"
