name: Publish to Maven Central

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      publish_type:
        description: 'Publish type (staging or release)'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - release

jobs:
  # Build SDK and Publish to Maven Central
  build-and-publish:
    name: Build & Publish SDK
    runs-on: ubuntu-latest
    environment: release
    steps:
      - name: Checkout kit-android code
        uses: actions/checkout@v4

      - name: Checkout kit repository
        uses: actions/checkout@v4
        with:
          repository: ton-connect/kit
          ref: fix/android-dto  # Branch with RequestError and nullable fixes
          path: ton-repo
          sparse-checkout: |
            packages/walletkit
            packages/walletkit-android-bridge

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION=$(grep "VERSION_NAME=" TONWalletKit-Android/gradle.properties | cut -d'=' -f2)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install openapi-generator
        run: |
          npm install -g @openapitools/openapi-generator-cli
          ln -sf "$(npm config get prefix)/bin/openapi-generator-cli" "$(npm config get prefix)/bin/openapi-generator" || true

      - name: Generate Kotlin models from walletkit API
        run: |
          chmod +x Scripts/generate-api/generate-api-models.sh
          bash -x ./Scripts/generate-api/generate-api-models.sh ./ton-repo/packages/walletkit

      - name: Build TypeScript Bridge Bundle
        run: |
          cd ton-repo
          pnpm install
          pnpm turbo run build --filter=walletkit-android-bridge --force

      - name: Copy Bridge Bundle to dist-android
        run: |
          mkdir -p dist-android
          cp ton-repo/packages/walletkit-android-bridge/dist/* dist-android/

      - name: Grant execute permission for gradlew
        working-directory: TONWalletKit-Android
        run: chmod +x gradlew

      - name: Sync WebView Assets
        working-directory: TONWalletKit-Android
        run: ./gradlew syncWalletKitWebViewAssets

      # COMMENTED OUT: Skipping unit tests for faster publishing
      # - name: Run unit tests
      #   working-directory: TONWalletKit-Android
      #   run: ./gradlew :impl:testWebviewDebugUnitTest

      - name: Build WebView variant (Release)
        working-directory: TONWalletKit-Android
        run: ./gradlew buildWebviewRelease

      - name: Upload WebView AAR
        uses: actions/upload-artifact@v4
        with:
          name: sdk-webview-aar
          path: TONWalletKit-Android/impl/build/outputs/aar/impl-webview-release.aar
          retention-days: 7

      - name: Publish to Maven Central (Staging)
        if: github.event_name == 'push' || inputs.publish_type == 'staging'
        working-directory: TONWalletKit-Android
        run: ./gradlew publishToMavenCentral --no-configuration-cache -PVERSION_NAME=${{ steps.version.outputs.version }}
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.SIGNING_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_KEY_CONTENTS }}

      - name: Publish to Maven Central (Auto-Release)
        if: github.event_name == 'workflow_dispatch' && inputs.publish_type == 'release'
        working-directory: TONWalletKit-Android
        run: ./gradlew publishAndReleaseToMavenCentral --no-configuration-cache -PVERSION_NAME=${{ steps.version.outputs.version }}
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.SIGNING_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_KEY_CONTENTS }}

      - name: Publishing summary
        run: |
          echo "âœ… Published to Maven Central"
          echo ""
          echo "ðŸ“¦ Artifact: org.ton:walletkit-android:${{ steps.version.outputs.version }}"
          echo ""
          if [ "${{ inputs.publish_type }}" == "release" ]; then
            echo "ðŸš€ Auto-released to Maven Central"
          else
            echo "ðŸ“¦ Next steps:"
            echo "1. Go to https://central.sonatype.com/publishing/deployments"
            echo "2. Review the staged artifacts"
            echo "3. Click 'Publish' to release to Maven Central"
          fi
