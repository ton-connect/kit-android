name: Android SDK CI

on:
  pull_request:
    branches:
      - main
      - feature/mock-unit-test  # Temporary - remove after testing
    paths:
      - 'TONWalletKit-Android/**'
      - 'AndroidDemo/**'
      - '.github/workflows/android-ci.yml'
      - '.github/workflows/android-e2e.yml'
  workflow_dispatch:

jobs:
  # Code formatting check with Spotless
  spotless:
    name: Spotless Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Grant execute permission for gradlew
        working-directory: TONWalletKit-Android
        run: chmod +x gradlew

      - name: Run Spotless Check
        working-directory: TONWalletKit-Android
        run: ./gradlew spotlessCheck

  # Build and test SDK
  test-sdk:
    name: Test & Build SDK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Grant execute permission for gradlew
        working-directory: TONWalletKit-Android
        run: chmod +x gradlew

      # TODO: Re-enable unit tests after merging SDK updates
      # - name: Run unit tests
      #   working-directory: TONWalletKit-Android
      #   run: ./gradlew :impl:testWebviewReleaseUnitTest

      - name: Build WebView variant
        working-directory: TONWalletKit-Android
        run: ./gradlew buildWebview

      - name: Upload WebView AAR
        uses: actions/upload-artifact@v4
        with:
          name: bridge-webview-release
          path: TONWalletKit-Android/impl/build/outputs/aar/impl-webview-release.aar
          retention-days: 7

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: TONWalletKit-Android/impl/build/test-results/
          retention-days: 7

  # Build Demo App (reused by E2E tests)
  build-demo:
    name: Build Demo App
    runs-on: ubuntu-latest
    needs: test-sdk
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Download SDK AAR
        uses: actions/download-artifact@v4
        with:
          name: bridge-webview-release
          path: AndroidDemo/app/libs/

      - name: Rename AAR
        run: mv AndroidDemo/app/libs/impl-webview-release.aar AndroidDemo/app/libs/bridge-release.aar

      - name: Grant execute permission for gradlew
        working-directory: AndroidDemo
        run: chmod +x gradlew

      - name: Build Demo App
        working-directory: AndroidDemo
        run: ./gradlew assembleDebug

      - name: Build Android Test APK
        working-directory: AndroidDemo
        run: ./gradlew assembleDebugAndroidTest

      - name: Prepare APKs for upload
        run: |
          mkdir -p demo-apks
          cp AndroidDemo/app/build/outputs/apk/debug/app-debug.apk demo-apks/
          cp AndroidDemo/app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk demo-apks/

      - name: Upload Demo APKs
        uses: actions/upload-artifact@v4
        with:
          name: demo-apks
          path: demo-apks/
          retention-days: 7
