<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Duplicate Call ID Mock</title>
</head>
<body>
    <script>
        /**
         * Duplicate Call ID Mock - Tests SDK handling of duplicate responses
         * 
         * Simulates a buggy backend that sends the same response multiple times.
         * The SDK should ignore duplicate responses and not crash or re-process them.
         */

        window.__walletkit_mock_state = {
          ready: false,
          seenCallIds: new Set()
        };

        function sendToAndroid(payload) {
          const message = JSON.stringify(payload);
          console.log('[Duplicate CallID Mock] Sending to Android:', message);
          
          if (window.WalletKitNative && window.WalletKitNative.postMessage) {
            window.WalletKitNative.postMessage(message);
          } else {
            console.error('[Duplicate CallID Mock] WalletKitNative.postMessage not available!');
          }
        }

        function sendRpcResponse(id, result, error) {
          const payload = {
            kind: 'response',
            id: id
          };
          
          if (error) {
            payload.error = error;
          } else {
            payload.result = result;
          }
          
          sendToAndroid(payload);
        }

        // Send ready immediately
        setTimeout(() => {
            sendToAndroid({
                kind: 'ready',
                network: 'testnet',
                tonApiUrl: 'https://testnet.tonapi.io'
            });
            window.__walletkit_mock_state.ready = true;
        }, 50);

        // Handle RPC calls - send each response 3 times (duplicate bug)
        window.__walletkitCall = function(id, method, paramsJson) {
            console.log(`[Duplicate CallID Mock] __walletkitCall: ${method} (id=${id})`);
            
            // Parse params - SDK sends JSON string as third parameter
            let params = null;
            if (paramsJson && typeof paramsJson === 'string') {
                try {
                    params = JSON.parse(paramsJson);
                } catch (e) {
                    console.error('[Duplicate CallID Mock] Failed to parse params:', e);
                }
            }
            
            window.__walletkit_mock_state.seenCallIds.add(id);
            
            // Prepare response
            let result = { success: true };
            
            if (method === 'createTonMnemonic') {
                const words = [
                    'abandon', 'ability', 'able', 'about', 'above', 'absent',
                    'absorb', 'abstract', 'absurd', 'abuse', 'access', 'accident',
                    'account', 'accuse', 'achieve', 'acid', 'acoustic', 'acquire',
                    'across', 'act', 'action', 'actor', 'actress', 'actual'
                ];
                result = { items: words };
            }
            
            // Send the SAME response 3 times (simulating duplicate bug)
            console.log(`[Duplicate CallID Mock] Sending response #1 for id=${id}`);
            sendRpcResponse(id, result);
            
            setTimeout(() => {
                console.log(`[Duplicate CallID Mock] Sending DUPLICATE response #2 for id=${id}`);
                sendRpcResponse(id, result);
            }, 100);
            
            setTimeout(() => {
                console.log(`[Duplicate CallID Mock] Sending DUPLICATE response #3 for id=${id}`);
                sendRpcResponse(id, result);
            }, 200);
        };
    </script>
</body>
</html>
