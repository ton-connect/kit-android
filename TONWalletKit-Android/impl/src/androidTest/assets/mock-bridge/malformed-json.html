<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>WalletKit Mock - Malformed JSON</title>
</head>
<body>
<h3>Mock Bridge - Malformed JSON</h3>
<script>
    /**
     * Malformed JSON Mock - Tests SDK handling of invalid JSON messages
     * 
     * Simulates buggy JavaScript that sends malformed/corrupted messages:
     * - Invalid JSON syntax
     * - Truncated messages
     * - Non-JSON strings
     * - Circular references
     * 
     * SDK should gracefully handle parse errors without crashing.
     */

    window.__walletkit_mock_state = {
      ready: false,
      callCounter: 0,
      mnemonicCallCounter: 0  // Track only createTonMnemonic calls
    };

    // Helper to send raw (potentially invalid) strings to Android
    function sendRawToAndroid(rawString) {
      console.log('[Malformed JSON Mock] Sending RAW to Android:', rawString);
      
      if (window.WalletKitNative && window.WalletKitNative.postMessage) {
        window.WalletKitNative.postMessage(rawString);
      } else {
        console.error('[Malformed JSON Mock] WalletKitNative.postMessage not available!');
      }
    }

    function sendToAndroid(payload) {
      const message = JSON.stringify(payload);
      console.log('[Malformed JSON Mock] Sending to Android:', message);
      
      if (window.WalletKitNative && window.WalletKitNative.postMessage) {
        window.WalletKitNative.postMessage(message);
      } else {
        console.error('[Malformed JSON Mock] WalletKitNative.postMessage not available!');
      }
    }

    // Send ready event normally
    setTimeout(() => {
        sendToAndroid({
            kind: 'ready',
            network: 'testnet',
            tonApiUrl: 'https://testnet.tonapi.io'
        });
        window.__walletkit_mock_state.ready = true;
    }, 50);

    // After ready, send some malformed messages to test error handling
    setTimeout(() => {
        console.log('[Malformed JSON Mock] Sending malformed messages...');
        
        // 1. Invalid JSON syntax (missing closing brace)
        sendRawToAndroid('{"kind":"response","id":"test-1"');
        
        // 2. Truncated JSON
        sendRawToAndroid('{"kind":"res');
        
        // 3. Non-JSON string
        sendRawToAndroid('this is not json at all!');
        
        // 4. Invalid escape sequences
        sendRawToAndroid('{"kind":"response","data":"\\invalid\\escape"}');
        
        // 5. Empty string
        sendRawToAndroid('');
        
    }, 200);

    // Handle RPC calls - respond with valid AND invalid messages
    window.__walletkitCall = function(id, method, paramsJson) {
        const callNum = ++window.__walletkit_mock_state.callCounter;
        console.log(`[Malformed JSON Mock] __walletkitCall #${callNum}: ${method} (id=${id})`);
        
        // Parse params - SDK sends JSON string as third parameter
        let params = null;
        if (paramsJson && typeof paramsJson === 'string') {
            try {
                params = JSON.parse(paramsJson);
            } catch (e) {
                console.error('[Malformed JSON Mock] Failed to parse params:', e);
            }
        }
        
        // Only count createTonMnemonic calls for the malformed pattern
        // This way test setup calls (addEventListeners, removeEventListeners) don't interfere
        let shouldSendMalformed = false;
        if (method === 'createTonMnemonic') {
            const mnemonicCallNum = ++window.__walletkit_mock_state.mnemonicCallCounter;
            shouldSendMalformed = (mnemonicCallNum % 3 === 0);
            console.log(`[Malformed JSON Mock] createTonMnemonic call #${mnemonicCallNum}, shouldSendMalformed=${shouldSendMalformed}`);
        }
        
        if (shouldSendMalformed) {
            // Every 3rd createTonMnemonic call: send malformed response
            const malformedMsg = `{"kind":"response","id":"${id}","result":{"items":[`;
            console.log(`[Malformed JSON Mock] ⚠️⚠️⚠️ Sending MALFORMED response for createTonMnemonic ⚠️⚠️⚠️`);
            console.log(`[Malformed JSON Mock] Malformed message: ${malformedMsg}`);
            sendRawToAndroid(malformedMsg);
        } else {
            // Other calls: respond normally based on method
            let result = { success: true };
            
            if (method === 'createTonMnemonic') {
                const words = [
                    'abandon', 'ability', 'able', 'about', 'above', 'absent',
                    'absorb', 'abstract', 'absurd', 'abuse', 'access', 'accident',
                    'account', 'accuse', 'achieve', 'acid', 'acoustic', 'acquire',
                    'across', 'act', 'action', 'actor', 'actress', 'actual'
                ];
                result = { items: words };
            } else if (method === 'addEventListeners' || method === 'removeEventListeners') {
                // Event listener methods just return success
                result = { success: true };
            }
            
            console.log(`[Malformed JSON Mock] Call #${callNum} method=${method} - sending valid response`);
            sendToAndroid({
                kind: 'response',
                id: id,
                result: result
            });
        }
    };
</script>
</body>
</html>

```
</script>
</body>
</html>
