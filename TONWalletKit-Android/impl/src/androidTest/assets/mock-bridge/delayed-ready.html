<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Delayed Ready Mock</title>
</head>
<body>
    <script>
        /**
         * Delayed Ready Mock - Tests SDK handling of slow bridge initialization
         * 
         * Simulates a slow network or heavy JavaScript bundle load time.
         * Ready event is sent after 5 seconds to test SDK timeout/waiting behavior.
         */

        window.__walletkit_mock_state = {
          ready: false,
          network: 'testnet',
          tonApiUrl: 'https://testnet.tonapi.io'
        };

        function sendToAndroid(payload) {
          const message = JSON.stringify(payload);
          console.log('[Delayed Ready Mock] Sending to Android:', message);
          
          if (window.WalletKitNative && window.WalletKitNative.postMessage) {
            window.WalletKitNative.postMessage(message);
          } else {
            console.error('[Delayed Ready Mock] WalletKitNative.postMessage not available!');
          }
        }

        function sendReadyEvent() {
          window.__walletkit_mock_state.ready = true;
          
          sendToAndroid({
            kind: 'ready',
            network: 'testnet',
            tonApiUrl: 'https://testnet.tonapi.io'
          });
        }

        function sendRpcResponse(id, result, error) {
          const payload = {
            kind: 'response',
            id: id
          };
          
          if (error) {
            payload.error = error;
          } else {
            payload.result = result;
          }
          
          sendToAndroid(payload);
        }

        // Send ready event after 5 seconds (slow initialization)
        console.log('[Delayed Ready Mock] Waiting 5 seconds before sending ready...');
        setTimeout(() => {
            console.log('[Delayed Ready Mock] Sending ready event now');
            sendReadyEvent();
        }, 5000);

        // Handle RPC calls - respond normally once ready
        window.__walletkitCall = function(id, method, paramsJson) {
            console.log(`[Delayed Ready Mock] __walletkitCall: ${method} (id=${id})`);
            
            // Parse params - SDK sends JSON string as third parameter
            let params = null;
            if (paramsJson && typeof paramsJson === 'string') {
                try {
                    params = JSON.parse(paramsJson);
                } catch (e) {
                    console.error('[Delayed Ready Mock] Failed to parse params:', e);
                }
            }
            
            if (!window.__walletkit_mock_state.ready) {
                // Before ready: queue or reject
                console.warn('[Delayed Ready Mock] Call received before ready!');
            }
            
            // Handle common methods
            if (method === 'createTonMnemonic') {
                const words = [
                    'abandon', 'ability', 'able', 'about', 'above', 'absent',
                    'absorb', 'abstract', 'absurd', 'abuse', 'access', 'accident',
                    'account', 'accuse', 'achieve', 'acid', 'acoustic', 'acquire',
                    'across', 'act', 'action', 'actor', 'actress', 'actual'
                ];
                sendRpcResponse(id, { items: words });
            } else {
                sendRpcResponse(id, { success: true });
            }
        };
    </script>
</body>
</html>
