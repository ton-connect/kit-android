<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Early Events</title>
</head>
<body>
<script>
    /**
     * Scenario #13: Event arrives before handler registered
     * Scenario #14: Event arrives after handler removed
     */

    function sendToAndroid(payload) {
        const message = JSON.stringify(payload);
        console.log('[Early Events] Sending to Android:', message);
        if (window.WalletKitNative && window.WalletKitNative.postMessage) {
            window.WalletKitNative.postMessage(message);
        } else {
            console.error('[Early Events] WalletKitNative.postMessage not available!');
        }
    }

    function sendReadyEvent(network) {
        sendToAndroid({ kind: 'ready', network: network, tonApiUrl: 'https://testnet.tonapi.io' });
    }

    function sendEvent(eventType, eventData) {
        sendToAndroid({
            kind: 'event',
            event: { type: eventType, data: eventData, id: 'event-' + Date.now() + '-' + Math.random() }
        });
    }

    // Send event IMMEDIATELY before ready
    sendEvent('accounts_changed', { accounts: [] });

    setTimeout(function() {
        sendReadyEvent('testnet');
    }, 100);

    // Send more events rapid-fire
    for (var i = 0; i < 10; i++) {
        (function(index) {
            setTimeout(function() {
                sendEvent('chain_changed', { chain: 'ton' });
            }, 50 + index * 10);
        })(i);
    }

    window.__walletkitCall = function(id, method, params) {
        console.log('[Early Events] Method call:', method);
    };
</script>
</body>
</html>
