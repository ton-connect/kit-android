<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>WalletKit Mock - Multiple Ready Events</title>
</head>
<body>
<h3>Mock Bridge - Multiple Ready Events</h3>
<script>
    /**
     * Edge Case: Multiple Rapid Ready Events
     * 
     * Scenario #23: Multiple "ready" events from JS (Bridge ready event fires multiple times)
     * Tests SDK's ability to handle JS context reload/recovery
     */

    function sendToAndroid(payload) {
        const message = JSON.stringify(payload);
        console.log('[MULTI_READY] Sending to Android:', message);
        if (window.WalletKitNative && window.WalletKitNative.postMessage) {
            window.WalletKitNative.postMessage(message);
        } else {
            console.error('[MULTI_READY] WalletKitNative.postMessage not available!');
        }
    }

    function sendReadyEvent(network, tonApiUrl) {
        sendToAndroid({ kind: 'ready', network: network, tonApiUrl: tonApiUrl });
    }

    function sendRpcResponse(id, result, error) {
        const payload = { kind: 'response', id: id };
        if (error) { payload.error = error; } else { payload.result = result; }
        sendToAndroid(payload);
    }

    // Send first ready event
    setTimeout(function() {
        console.log('[MULTI_READY] Sending first ready event (testnet)');
        sendReadyEvent('testnet', 'https://testnet.tonapi.io');
    }, 100);

    // Send second ready event with DIFFERENT network
    setTimeout(function() {
        console.log('[MULTI_READY] Sending second ready event (mainnet)');
        sendReadyEvent('mainnet', 'https://tonapi.io');
    }, 500);

    // Send third ready event (back to testnet)
    setTimeout(function() {
        console.log('[MULTI_READY] Sending third ready event (testnet again)');
        sendReadyEvent('testnet', 'https://testnet.tonapi.io');
    }, 1000);

    // Handle RPC calls normally
    window.__walletkitCall = function(id, method, params) {
        sendRpcResponse(id, { success: true });
    };

    console.log('[MULTI_READY] Mock initialized');
</script>
</body>
</html>
