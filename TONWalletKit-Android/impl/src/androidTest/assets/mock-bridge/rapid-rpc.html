<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Rapid RPC Mock</title>
</head>
<body>
    <script>
        /**
         * Base Mock Bridge - Inlined utilities for rapid RPC testing
         */

        // Global state
        window.__walletkit_mock_state = {
          ready: false,
          network: 'testnet',
          tonApiUrl: 'https://testnet.tonapi.io',
          eventListenersRegistered: false,
          pendingCalls: new Map(),
          sessionStorage: new Map()
        };

        /**
         * Send message to Android via the JavascriptInterface
         */
        function sendToAndroid(payload) {
          const message = JSON.stringify(payload);
          console.log('[MOCK] Sending to Android:', message);
          
          // The SDK exposes WalletKitNative.postMessage() as the bridge
          if (window.WalletKitNative && window.WalletKitNative.postMessage) {
            window.WalletKitNative.postMessage(message);
          } else {
            console.error('[MOCK] WalletKitNative.postMessage not available!');
          }
        }

        /**
         * Send ready event
         */
        function sendReadyEvent(network, tonApiUrl) {
          window.__walletkit_mock_state.ready = true;
          window.__walletkit_mock_state.network = network;
          window.__walletkit_mock_state.tonApiUrl = tonApiUrl;
          
          sendToAndroid({
            kind: 'ready',
            network: network,
            tonApiUrl: tonApiUrl
          });
        }

        /**
         * Send RPC response
         */
        function sendRpcResponse(id, result, error) {
          const payload = {
            kind: 'response',
            id: id
          };
          
          if (error) {
            payload.error = error;
          } else {
            payload.result = result;
          }
          
          sendToAndroid(payload);
        }

        /**
         * Rapid RPC Mock Implementation
         */
        const pendingCalls = [];
        let callCounter = 0;

        // Send ready event immediately
        setTimeout(() => {
            sendReadyEvent('testnet', 'https://testnet.tonapi.io');
        }, 50);

        // Handle RPC calls - queue them and respond later in batch
        window.__walletkitCall = function(id, method, params) {
            console.log(`[Rapid RPC Mock] Queuing call #${callCounter++}: ${method} (id=${id})`);
            pendingCalls.push({ id, method, params });
            
            // After collecting calls for 300ms, respond to all at once
            if (pendingCalls.length === 1) {
                setTimeout(() => {
                    console.log(`[Rapid RPC Mock] Responding to ${pendingCalls.length} calls simultaneously`);
                    
                    // Respond to all calls at the same time to test concurrent handling
                    pendingCalls.forEach((call, index) => {
                        if (call.method === 'createTonMnemonic') {
                            // Generate unique but valid mnemonic for each call
                            // SDK expects { items: [...] } format
                            const words = [
                                'abandon', 'ability', 'able', 'about', 'above', 'absent',
                                'absorb', 'abstract', 'absurd', 'abuse', 'access', 'accident',
                                'account', 'accuse', 'achieve', 'acid', 'acoustic', 'acquire',
                                'across', 'act', 'action', 'actor', 'actress', `word${index}`
                            ];
                            sendRpcResponse(call.id, { items: words });
                        } else {
                            // Other methods get generic success
                            sendRpcResponse(call.id, { success: true });
                        }
                    });
                    
                    pendingCalls.length = 0; // Clear queue
                }, 300);
            }
        };
    </script>
</body>
</html>
